# .github/workflows/ios-ci.yml

name: iOS CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Job 1: Build the app, run tests, and generate all necessary reports.
  build-and-test:
    name: Build and Test
    runs-on: macos-latest # Xcode builds must run on macOS

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # SonarCloud requires the full git history to assign issues correctly.
          fetch-depth: 0

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      # Install SonarScanner (which includes the build-wrapper) using Homebrew.
      # This is the most reliable method when direct downloads fail.
      - name: Install SonarScanner via Homebrew
        run: brew install sonar-scanner

      - name: Run Build & Tests with Coverage and Wrapper
        run: |
          # Use `brew --prefix` to get the correct path to the sonar-scanner installation,
          # then call the build-wrapper from its standard location within the libexec directory.
          "$(brew --prefix sonar-scanner)/libexec/build-wrapper-macos-x86/build-wrapper-macos-x86" --out-dir sonar-build-wrapper-output \
            xcodebuild clean test \
              -project RelationshipCoach.xcodeproj \
              -scheme "RelationshipCoach" \
              -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=latest' \
              -resultBundlePath 'test-results' \
              -enableCodeCoverage YES \
              CODE_SIGNING_ALLOWED=NO

      - name: Upload Test Results Artifact (for Codecov)
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.xcresult

      - name: Upload SonarQube Build Wrapper Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sonar-build-wrapper-output
          path: sonar-build-wrapper-output/

  # Job 2: Upload coverage report to Codecov.
  codecov:
    name: Upload to Codecov
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Test Results Artifact
        uses: actions/download-artifact@v4
        with:
          name: test-results

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./test-results.xcresult
          flags: unittests

  # Job 3: Run SonarQube analysis.
  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download SonarQube Build Wrapper Artifact
        uses: actions/download-artifact@v4
        with:
          name: sonar-build-wrapper-output
          path: sonar-build-wrapper-output/

      # Manually download and set up the SonarScanner CLI for the Linux runner.
      - name: Install SonarScanner CLI
        run: |
          curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -o sonar-scanner.zip
          echo "$(pwd)/sonar-scanner-5.0.1.3006-linux/bin" >> $GITHUB_PATH

      - name: Run SonarQube Scanner
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=nanirocks125_RelationshipCoach \
            -Dsonar.organization=manikanta-nandam \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.cfamily.build-wrapper-output=sonar-build-wrapper-output
